{% extends "base.html" %}

{% block title %}{{ year }}年{{ month }}月報表 - 財務管理系統{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-md-6">
      <h2>
        <i class="bi bi-file-earmark-bar-graph"></i>
        {{ year }} 年 {{ month }} 月報表
      </h2>
    </div>
    <div class="col-md-6 text-end">
      <a href="{{ url_for('reports.index') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> 返回列表
      </a>
      <form method="POST" action="{{ url_for('reports.regenerate', year=year, month=month) }}" class="d-inline"
        onsubmit="return confirm('確定要重新生成這份報表嗎？');">
        <button type="submit" class="btn btn-outline-primary">
          <i class="bi bi-arrow-clockwise"></i> 重新生成
        </button>
      </form>
    </div>
  </div>

  <!-- 摘要卡片 -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-body text-center">
          <h6>總收入</h6>
          <h3>${{ "%.2f"|format(report.total_income|float) }}</h3>
          <small>{{ report_data.summary.income_count or 0 }} 筆</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-danger text-white">
        <div class="card-body text-center">
          <h6>總支出</h6>
          <h3>${{ "%.2f"|format(report.total_expense|float) }}</h3>
          <small>{{ report_data.summary.expense_count or 0 }} 筆</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white">
        <div class="card-body text-center">
          <h6>淨收入</h6>
          <h3>${{ "%.2f"|format(report.net_amount|float) }}</h3>
          {% if report.total_income|float > 0 %}
          <small>儲蓄率 {{ "%.1f"|format((report.net_amount|float / report.total_income|float * 100)) }}%</small>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-white">
        <div class="card-body text-center">
          <h6>交易筆數</h6>
          <h3>{{ report_data.summary.total_count or 0 }}</h3>
          <small>本月記錄</small>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- 左側：圖表 -->
    <div class="col-lg-8">
      <!-- 類別分布圖 -->
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="bi bi-pie-chart"></i> 收支分布
          </h5>
        </div>
        <div class="card-body">
          <canvas id="categoryPieChart" height="80"></canvas>
        </div>
      </div>

      <!-- 每日趨勢圖 -->
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="bi bi-graph-up"></i> 每日收支趨勢
          </h5>
        </div>
        <div class="card-body">
          <canvas id="dailyTrendChart" height="80"></canvas>
        </div>
      </div>

      <!-- 最大支出項目 -->
      {% if report_data.top_expenses %}
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="bi bi-arrow-down-circle-fill text-danger"></i> 最大支出項目
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>日期</th>
                  <th>類別</th>
                  <th>描述</th>
                  <th class="text-end">金額</th>
                </tr>
              </thead>
              <tbody>
                {% for expense in report_data.top_expenses %}
                <tr>
                  <td>{{ expense.date }}</td>
                  <td>
                    <span class="badge bg-danger">{{ expense.category }}</span>
                  </td>
                  <td>{{ expense.description }}</td>
                  <td class="text-end text-danger fw-bold">
                    ${{ "%.2f"|format(expense.amount) }}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- 右側：見解與建議 -->
    <div class="col-lg-4">
      <!-- 分析見解 -->
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="bi bi-lightbulb"></i> 分析見解
          </h5>
        </div>
        <div class="card-body">
          {% if report_data.insights %}
          {% for insight in report_data.insights %}
          <div class="alert alert-{{ insight.type }} py-2 px-3 mb-2">
            <small>
              {{ insight.icon }} <strong>{{ insight.title }}</strong><br>
              {{ insight.message }}
            </small>
          </div>
          {% endfor %}
          {% else %}
          <p class="text-muted text-center mb-0">暫無分析資料</p>
          {% endif %}
        </div>
      </div>

      <!-- 環比資料 -->
      {% if report_data.comparison %}
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="bi bi-graph-up-arrow"></i> 環比變化
          </h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <small class="text-muted">收入變化</small>
            <div class="d-flex justify-content-between align-items-center">
              <span
                class="{% if report_data.comparison.month_over_month.income_change >= 0 %}text-success{% else %}text-danger{% endif %}">
                {{ "%.1f"|format(report_data.comparison.month_over_month.income_change) }}%
              </span>
              <i
                class="bi bi-{% if report_data.comparison.month_over_month.income_change >= 0 %}arrow-up{% else %}arrow-down{% endif %}-circle"></i>
            </div>
          </div>
          <div class="mb-3">
            <small class="text-muted">支出變化</small>
            <div class="d-flex justify-content-between align-items-center">
              <span
                class="{% if report_data.comparison.month_over_month.expense_change >= 0 %}text-danger{% else %}text-success{% endif %}">
                {{ "%.1f"|format(report_data.comparison.month_over_month.expense_change) }}%
              </span>
              <i
                class="bi bi-{% if report_data.comparison.month_over_month.expense_change >= 0 %}arrow-up{% else %}arrow-down{% endif %}-circle"></i>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- 目標相關 -->
      {% if report_data.goals %}
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="bi bi-bullseye"></i> 相關目標
          </h5>
        </div>
        <div class="card-body">
          {% for goal in report_data.goals %}
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <small class="text-muted">{{ goal.name }}</small>
              <span class="badge 
                                {% if goal.status == 'completed' %}bg-success
                                {% elif goal.status == 'active' %}bg-info
                                {% else %}bg-secondary{% endif %}">
                {{ goal.status }}
              </span>
            </div>
            <div class="progress" style="height: 6px;">
              <div class="progress-bar" style="width: {{ goal.progress }}%"></div>
            </div>
            <small class="text-muted">
              ${{ "%.2f"|format(goal.current_amount) }} / ${{ "%.2f"|format(goal.target_amount) }}
            </small>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // 類別圓餅圖
  {% if report_data.category_stats %}
  const categoryStats = {{ report_data.category_stats| tojson }};
  const expenseLabels = categoryStats.expense.map(c => c.category);
  const expenseAmounts = categoryStats.expense.map(c => c.amount);

  const pieCtx = document.getElementById('categoryPieChart');
  new Chart(pieCtx, {
    type: 'pie',
    data: {
      labels: expenseLabels,
      datasets: [{
        data: expenseAmounts,
        backgroundColor: [
          'rgba(255, 99, 132, 0.7)',
          'rgba(54, 162, 235, 0.7)',
          'rgba(255, 206, 86, 0.7)',
          'rgba(75, 192, 192, 0.7)',
          'rgba(153, 102, 255, 0.7)',
          'rgba(255, 159, 64, 0.7)',
          'rgba(201, 203, 207, 0.7)'
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
  {% endif %}

  // 每日趨勢圖
  {% if report_data.daily_stats %}
  const dailyStats = {{ report_data.daily_stats| tojson }};
  const dates = dailyStats.map(d => d.date);
  const dailyIncome = dailyStats.map(d => d.income);
  const dailyExpense = dailyStats.map(d => d.expense);

  const trendCtx = document.getElementById('dailyTrendChart');
  new Chart(trendCtx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: '收入',
        data: dailyIncome,
        borderColor: 'rgb(25, 135, 84)',
        backgroundColor: 'rgba(25, 135, 84, 0.1)',
        tension: 0.1
      }, {
        label: '支出',
        data: dailyExpense,
        borderColor: 'rgb(220, 53, 69)',
        backgroundColor: 'rgba(220, 53, 69, 0.1)',
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
  {% endif %}
</script>
{% endblock %}