{% extends "base.html" %}

{% block title %}財務目標 - 財務管理系統{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-md-6">
      <h2><i class="bi bi-bullseye"></i> 財務目標</h2>
    </div>
    <div class="col-md-6 text-end">
      <a href="{{ url_for('goals.add') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> 新增目標
      </a>
    </div>
  </div>

  <!-- 統計 -->
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card">
        <div class="card-body text-center">
          <h3 class="text-primary">{{ total_goals }}</h3>
          <p class="text-muted mb-0">總目標數</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card">
        <div class="card-body text-center">
          <h3 class="text-info">{{ active_goals }}</h3>
          <p class="text-muted mb-0">進行中</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card">
        <div class="card-body text-center">
          <h3 class="text-success">{{ completed_goals }}</h3>
          <p class="text-muted mb-0">已完成</p>
        </div>
      </div>
    </div>
  </div>

  <!-- 篩選 -->
  <div class="mb-3">
    <div class="btn-group" role="group">
      <a href="{{ url_for('goals.index', status='active') }}"
        class="btn btn-sm {% if status_filter == 'active' %}btn-primary{% else %}btn-outline-primary{% endif %}">
        進行中
      </a>
      <a href="{{ url_for('goals.index', status='completed') }}"
        class="btn btn-sm {% if status_filter == 'completed' %}btn-primary{% else %}btn-outline-primary{% endif %}">
        已完成
      </a>
      <a href="{{ url_for('goals.index', status='cancelled') }}"
        class="btn btn-sm {% if status_filter == 'cancelled' %}btn-primary{% else %}btn-outline-primary{% endif %}">
        已取消
      </a>
      <a href="{{ url_for('goals.index', status='all') }}"
        class="btn btn-sm {% if status_filter == 'all' %}btn-primary{% else %}btn-outline-primary{% endif %}">
        全部
      </a>
    </div>
  </div>

  <!-- 目標列表 -->
  {% if goals %}
  <div class="row g-3">
    {% for goal in goals %}
    <div class="col-md-6 col-lg-4">
      <div
        class="card h-100 {% if goal.status == 'completed' %}border-success{% elif goal.is_overdue %}border-danger{% endif %}">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h5 class="card-title mb-0">{{ goal.name }}</h5>
            <span class="badge 
                            {% if goal.status == 'active' %}bg-info
                            {% elif goal.status == 'completed' %}bg-success
                            {% else %}bg-secondary{% endif %}">
              {% if goal.status == 'active' %}進行中
              {% elif goal.status == 'completed' %}已完成
              {% else %}已取消{% endif %}
            </span>
          </div>

          <p class="text-muted small mb-2">
            <i class="bi bi-tag"></i>
            {{ '儲蓄目標' if goal.goal_type == 'saving' else '支出限制' }}
            {% if goal.period == 'monthly' %}（每月）
            {% elif goal.period == 'yearly' %}（每年）
            {% else %}（自訂）{% endif %}
          </p>

          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <small>進度</small>
              <small class="fw-bold">{{ "%.1f"|format(goal.progress) }}%</small>
            </div>
            <div class="progress" style="height: 12px;">
              <div class="progress-bar 
                                {% if goal.progress >= 100 %}bg-success
                                {% elif goal.progress >= 75 %}bg-info
                                {% elif goal.progress >= 50 %}bg-warning
                                {% else %}bg-danger{% endif %}" style="width: {{ goal.progress }}%">
              </div>
            </div>
            <div class="d-flex justify-content-between mt-1">
              <small class="text-muted">
                ${{ "%.2f"|format(goal.current_amount|float) }}
              </small>
              <small class="text-muted">
                ${{ "%.2f"|format(goal.target_amount|float) }}
              </small>
            </div>
          </div>

          <p class="text-muted small mb-3">
            <i class="bi bi-calendar"></i>
            {{ goal.start_date.strftime('%Y-%m-%d') }}
            {% if goal.end_date %}
            至 {{ goal.end_date.strftime('%Y-%m-%d') }}
            {% if goal.is_overdue %}
            <span class="badge bg-danger">已過期</span>
            {% endif %}
            {% endif %}
          </p>

          <div class="d-grid gap-2">
            {% if goal.status == 'active' %}
            {% if goal.progress >= 100 %}
            <form method="POST" action="{{ url_for('goals.complete', id=goal.id) }}">
              <button type="submit" class="btn btn-success btn-sm w-100">
                <i class="bi bi-check-circle"></i> 標記為完成
              </button>
            </form>
            {% endif %}
            <a href="{{ url_for('goals.edit', id=goal.id) }}" class="btn btn-outline-primary btn-sm">
              <i class="bi bi-pencil"></i> 編輯
            </a>
            <form method="POST" action="{{ url_for('goals.cancel', id=goal.id) }}"
              onsubmit="return confirm('確定要取消這個目標嗎？');">
              <button type="submit" class="btn btn-outline-warning btn-sm w-100">
                <i class="bi bi-x-circle"></i> 取消目標
              </button>
            </form>
            {% elif goal.status == 'cancelled' %}
            <form method="POST" action="{{ url_for('goals.reactivate', id=goal.id) }}">
              <button type="submit" class="btn btn-outline-info btn-sm w-100">
                <i class="bi bi-arrow-clockwise"></i> 重新啟動
              </button>
            </form>
            {% endif %}
            <form method="POST" action="{{ url_for('goals.delete', id=goal.id) }}"
              onsubmit="return confirm('確定要刪除這個目標嗎？此操作無法復原。');">
              <button type="submit" class="btn btn-outline-danger btn-sm w-100">
                <i class="bi bi-trash"></i> 刪除
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="card">
    <div class="card-body text-center text-muted py-5">
      <i class="bi bi-target" style="font-size: 4rem;"></i>
      <p class="mt-3 h5">沒有找到目標</p>
      <p>設定您的第一個財務目標吧！</p>
      <a href="{{ url_for('goals.add') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> 新增目標
      </a>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}